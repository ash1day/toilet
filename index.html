<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }

      #map_canvas { height: 100% }
      .svg_container {
          width : 100%;
          height: 100%;
      }
      .svg_container svg {
          width : 8000px;
          height: 8000px;
      }
    </style>
    <script type="text/javascript"
            src ="https://maps.googleapis.com/maps/api/js?sensor=false&language=ja">
    </script>
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script type="text/javascript">
      function initialize() {
        // 位置情報データ取得
        var sparqlQueryURI = 'http://lod.ac/sabae/sparql?query=SELECT+*%0A++WHERE+%7B%0A++++%3Furi+%3Chttp%3A%2F%2Fwww.w3.org%2F2003%2F01%2Fgeo%2Fwgs84_pos%23lat%3E+%3Flatitude+.%0A+++++%3Furi+%3Chttp%3A%2F%2Fwww.w3.org%2F2003%2F01%2Fgeo%2Fwgs84_pos%23long%3E+%3Flongitude+.+FILTER+regex(str(%3Furi)%2C+%22toilet%22)%0A++%7D&format=json';
        d3.json(sparqlQueryURI, function(pointsJson){

          // 位置情報データから母点の座標情報に
          var sitePointsCoordinates = [];
          pointsJson.results.bindings.forEach(function(point){
            sitePointsCoordinates.push([point.longitude.value, point.latitude.value]);
          });

          var geocoder = new google.maps.Geocoder();
          geocoder.geocode({
            'address': '福井県鯖江市'
          },function(result, status){
            if (status == google.maps.GeocoderStatus.OK){
              drawMap(result[0].geometry.location, sitePointsCoordinates);
            } else {
              alert('error');
            }
          });
        });
      }

      function drawMap(location, sitePointsCoordinates) {
        var mapOptions = {
          center : location,
          zoom   : 14
        };

        var map = new google.maps.Map(document.getElementById("map_canvas"),mapOptions);
        var overlay = new google.maps.OverlayView();

        overlay.onAdd = function () {
          var layer = d3.select(this.getPanes().overlayLayer).append("div").attr("class", "svg_container");
          var svg = layer.append("svg");

          overlay.draw = function () {
            // 緯度・経度データをピクセル情報に変換
            var projection = this.getProjection();
            var googleMapProjection = function (coordinates) {
                var googleCoordinates = new google.maps.LatLng(coordinates[1], coordinates[0]);
                var coordinatesPx = projection.fromLatLngToDivPixel(googleCoordinates);
                return [coordinatesPx.x, coordinatesPx.y];
            };
            var sitePointsCoordinatesPx = [];
            sitePointsCoordinates.forEach(function(coordinates) {
              sitePointsCoordinatesPx.push(googleMapProjection(coordinates));
            });

            // TODO: トイレだと分かるようなマークに
            // 母点描画
            var sitePointsAttributes = {
              "class": "site_points",
              "cx" : function(d, i) { return sitePointsCoordinatesPx[i][0]; },
              "cy" : function(d, i) { return sitePointsCoordinatesPx[i][1]; },
              "r"  : 5,
              "fill"   : "#ecf0f1",
              "stroke" : "#2980b9",
              "stroke-width" : 1.5
            };
            svg.selectAll("circle.site_points")
              .data(sitePointsCoordinatesPx)
              .attr(sitePointsAttributes)
              .enter()
              .append("svg:circle")
              .attr(sitePointsAttributes);
          };
        };
        overlay.setMap(map);
      }
      google.maps.event.addDomListener(window, 'load', initialize);
    </script>
  </head>
  <body>
    <div id="map_canvas"/>
  </body>
</html>